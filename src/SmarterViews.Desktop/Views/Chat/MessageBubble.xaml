<UserControl x:Class="SmarterViews.Desktop.Views.Chat.MessageBubble"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mdxaml="clr-namespace:MdXaml;assembly=MdXaml"
             xmlns:vm="clr-namespace:SmarterViews.Desktop.ViewModels.Chat"
             xmlns:converters="clr-namespace:SmarterViews.Desktop.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="200" d:DesignWidth="600"
             d:DataContext="{d:DesignInstance Type=vm:MessageViewModel}">
    
    <UserControl.Resources>
        <converters:RoleToColorConverter x:Key="RoleToColorConverter" />
        <converters:RoleToAlignmentConverter x:Key="RoleToAlignmentConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        
        <!-- Attachment item template for message display -->
        <DataTemplate x:Key="MessageAttachmentTemplate" DataType="{x:Type vm:MessageAttachmentViewModel}">
            <Border Background="#252536" 
                    CornerRadius="8" 
                    Padding="8"
                    Margin="0,0,8,8"
                    MaxWidth="200">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    
                    <!-- Image thumbnail -->
                    <Border Grid.Row="0" 
                            CornerRadius="4"
                            Visibility="{Binding IsImage, Converter={StaticResource BoolToVisibilityConverter}}"
                            MaxWidth="180"
                            MaxHeight="150">
                        <Image Source="{Binding Thumbnail}" 
                               Stretch="Uniform"
                               RenderOptions.BitmapScalingMode="HighQuality" />
                    </Border>
                    
                    <!-- PDF icon for documents -->
                    <Border Grid.Row="0" 
                            Background="#313244" 
                            CornerRadius="4"
                            Width="80" 
                            Height="60"
                            HorizontalAlignment="Left"
                            Visibility="{Binding IsDocument, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="PDF" 
                                       FontSize="18" 
                                       FontWeight="Bold"
                                       Foreground="#F38BA8"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                    
                    <!-- File info -->
                    <StackPanel Grid.Row="1" Margin="0,6,0,0">
                        <TextBlock Text="{Binding FileName}" 
                                   Foreground="#CDD6F4"
                                   FontSize="11"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="180"
                                   ToolTip="{Binding FileName}" />
                        <TextBlock Text="{Binding FileSizeDisplay}" 
                                   Foreground="#6C7086"
                                   FontSize="10" />
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>
    
    <Grid Margin="16,8" HorizontalAlignment="{Binding Role, Converter={StaticResource RoleToAlignmentConverter}}">
        <Border Background="{Binding Role, Converter={StaticResource RoleToColorConverter}}"
                CornerRadius="12"
                Padding="16,12"
                MaxWidth="700"
                MinWidth="100">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <!-- Role label -->
                <TextBlock Grid.Row="0"
                           Text="{Binding RoleDisplayName}"
                           FontWeight="SemiBold"
                           FontSize="12"
                           Foreground="#89B4FA"
                           Margin="0,0,0,8" />
                
                <!-- Attachments display -->
                <ItemsControl Grid.Row="1"
                              ItemsSource="{Binding Attachments}"
                              ItemTemplate="{StaticResource MessageAttachmentTemplate}"
                              Visibility="{Binding HasAttachments, Converter={StaticResource BoolToVisibilityConverter}}"
                              Margin="0,0,0,8">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
                
                <!-- Message content with markdown -->
                <mdxaml:MarkdownScrollViewer Grid.Row="2"
                                              Markdown="{Binding Content}"
                                              VerticalScrollBarVisibility="Disabled"
                                              HorizontalScrollBarVisibility="Disabled"
                                              Background="Transparent">
                    <mdxaml:MarkdownScrollViewer.MarkdownStyle>
                        <Style TargetType="FlowDocument">
                            <Setter Property="FontFamily" Value="Segoe UI Variable, Segoe UI" />
                            <Setter Property="FontSize" Value="14" />
                            <Setter Property="Foreground" Value="#CDD6F4" />
                            <Setter Property="PagePadding" Value="0" />
                        </Style>
                    </mdxaml:MarkdownScrollViewer.MarkdownStyle>
                </mdxaml:MarkdownScrollViewer>
                
                <!-- Streaming indicator -->
                <StackPanel Grid.Row="3" 
                            Orientation="Horizontal" 
                            Margin="0,8,0,0"
                            Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Ellipse Width="6" Height="6" Fill="#89B4FA" Margin="0,0,4,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsStreaming}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     From="1" To="0.3" Duration="0:0:0.5"
                                                                     AutoReverse="True" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="Streaming..." 
                               FontSize="11" 
                               Foreground="#6C7086" />
                </StackPanel>
                
                <!-- Token count and timestamp -->
                <StackPanel Grid.Row="3" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Right"
                            Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}">
                    <TextBlock Text="{Binding TokenCount, StringFormat='{}{0} tokens'}"
                               FontSize="11"
                               Foreground="#6C7086"
                               Margin="0,8,8,0"
                               Visibility="{Binding TokenCount, Converter={StaticResource BoolToVisibilityConverter}}" />
                    <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}"
                               FontSize="11"
                               Foreground="#6C7086"
                               Margin="0,8,0,0" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
