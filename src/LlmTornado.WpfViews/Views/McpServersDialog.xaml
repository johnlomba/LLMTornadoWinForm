<UserControl x:Class="LlmTornado.WpfViews.Views.McpServersDialog"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:vm="clr-namespace:LlmTornado.WpfViews.ViewModels"
             xmlns:models="clr-namespace:LlmTornado.WpfViews.Models"
             xmlns:converters="clr-namespace:LlmTornado.WpfViews.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="900"
             d:DataContext="{d:DesignInstance Type=vm:McpServersViewModel}">
    
    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        <converters:ArrayToStringConverter x:Key="ArrayToStringConverter" />
        
        <!-- Status color converter -->
        <Style x:Key="StatusEllipseStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="10" />
            <Setter Property="Height" Value="10" />
            <Setter Property="Fill" Value="#6C7086" />
            <Style.Triggers>
                <DataTrigger Binding="{Binding Status}" Value="Connected">
                    <Setter Property="Fill" Value="#A6E3A1" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Status}" Value="Disconnected">
                    <Setter Property="Fill" Value="#F9E2AF" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Status}" Value="Error">
                    <Setter Property="Fill" Value="#F38BA8" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    
    <Border Background="#1E1E2E" 
            CornerRadius="12" 
            BorderBrush="#45475A"
            BorderThickness="1"
            Padding="24"
            MinWidth="800"
            MaxWidth="1000"
            MinHeight="600"
            MaxHeight="800">
        <Border.Effect>
            <DropShadowEffect BlurRadius="20" 
                              ShadowDepth="0" 
                              Opacity="0.5" 
                              Color="Black" />
        </Border.Effect>
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            
            <!-- Header -->
            <Grid Grid.Row="0" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <TextBlock Text="MCP Servers"
                           FontSize="22"
                           FontWeight="SemiBold"
                           Foreground="#CDD6F4" />
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Command="{Binding InitializeAllServersCommand}"
                            Content="Initialize All"
                            Padding="12,6"
                            Margin="0,0,8,0"
                            Background="#89B4FA"
                            Foreground="#1E1E2E"
                            FontWeight="SemiBold"
                            Cursor="Hand"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="Border" 
                                        Background="{TemplateBinding Background}" 
                                        CornerRadius="6" 
                                        Padding="{TemplateBinding Padding}">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Border" Property="Background" Value="#B4BEFE" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    
                    <Button Click="CloseButton_Click"
                            Background="Transparent"
                            Padding="8"
                            Cursor="Hand"
                            ToolTip="Close">
                        <TextBlock Text="&#x2715;" 
                                   FontSize="16" 
                                   Foreground="#A6ADC8" />
                    </Button>
                </StackPanel>
            </Grid>
            
            <!-- Main content -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="300" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <!-- Server list -->
                <Border Grid.Column="0" 
                        Background="#181825"
                        CornerRadius="8"
                        Padding="12"
                        Margin="0,0,12,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        
                        <Button Grid.Row="0"
                                Command="{Binding AddServerCommand}"
                                Content="+ Add Server"
                                Padding="12,8"
                                Margin="0,0,0,12"
                                Background="#89B4FA"
                                Foreground="#1E1E2E"
                                FontWeight="SemiBold"
                                Cursor="Hand"
                                HorizontalAlignment="Stretch">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="Border" 
                                            Background="{TemplateBinding Background}" 
                                            CornerRadius="6" 
                                            Padding="{TemplateBinding Padding}">
                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="#B4BEFE" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                        
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding Servers}"
                                 SelectedItem="{Binding SelectedServer}"
                                 Background="Transparent"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate DataType="{x:Type models:McpServerViewModel}">
                                    <Border Background="#252536"
                                            CornerRadius="6"
                                            Padding="12,8"
                                            Margin="0,0,0,6"
                                            Cursor="Hand">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            
                                            <Ellipse Grid.Column="0"
                                                     Style="{StaticResource StatusEllipseStyle}"
                                                     DataContext="{Binding}"
                                                     Margin="0,0,8,0"
                                                     VerticalAlignment="Center" />
                                            
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="{Binding Label}"
                                                           Foreground="#CDD6F4"
                                                           FontWeight="SemiBold"
                                                           FontSize="13" />
                                                <TextBlock Text="{Binding Status, StringFormat='Status: {0}'}"
                                                           Foreground="#6C7086"
                                                           FontSize="11"
                                                           Margin="0,2,0,0" />
                                                <TextBlock Text="{Binding ToolCount, StringFormat='{}{0} tools'}"
                                                           Foreground="#6C7086"
                                                           FontSize="11" />
                                            </StackPanel>
                                            
                                            <Button Grid.Column="2"
                                                    Command="{Binding DataContext.RemoveServerCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding Label}"
                                                    Background="Transparent"
                                                    Padding="4"
                                                    Cursor="Hand"
                                                    ToolTip="Remove">
                                                <TextBlock Text="&#x2715;" 
                                                           FontSize="12" 
                                                           Foreground="#F38BA8" />
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>
                
                <!-- Splitter -->
                <GridSplitter Grid.Column="1" 
                              Width="1" 
                              Background="#45475A"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Stretch"
                              Margin="0,0,12,0" />
                
                <!-- Server details/edit panel -->
                <ScrollViewer Grid.Column="2" 
                              VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Error message -->
                        <Border Background="#F38BA8"
                                CornerRadius="8"
                                Padding="12"
                                Margin="0,0,0,16"
                                Visibility="{Binding ErrorMessage, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="{Binding ErrorMessage}"
                                       Foreground="#1E1E2E"
                                       TextWrapping="Wrap"
                                       FontWeight="Medium" />
                        </Border>
                        
                        <!-- Server configuration form -->
                        <StackPanel Visibility="{Binding SelectedServer, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Server Configuration"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="#CDD6F4"
                                       Margin="0,0,0,16" />
                            
                            <!-- Server Label -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Server Label"
                                           Foreground="#A6ADC8"
                                           FontSize="12"
                                           Margin="0,0,0,6" />
                                <TextBox Text="{Binding NewServerLabel, UpdateSourceTrigger=PropertyChanged}"
                                         IsReadOnly="{Binding IsEditing, Converter={StaticResource InverseBoolConverter}}"
                                         Background="#252536"
                                         Foreground="#CDD6F4"
                                         BorderBrush="#45475A"
                                         Padding="12,10" />
                            </StackPanel>
                            
                            <!-- Transport Type -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Transport Type"
                                           Foreground="#A6ADC8"
                                           FontSize="12"
                                           Margin="0,0,0,6" />
                                <ComboBox SelectedValue="{Binding EditingServer.Type, UpdateSourceTrigger=PropertyChanged}"
                                          Background="#252536"
                                          Foreground="#CDD6F4"
                                          BorderBrush="#45475A"
                                          Padding="12,10">
                                    <ComboBoxItem Content="stdio" />
                                    <ComboBoxItem Content="http" />
                                </ComboBox>
                            </StackPanel>
                            
                            <!-- Stdio configuration -->
                            <StackPanel Margin="0,0,0,16">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding EditingServer.Type}" Value="stdio">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <StackPanel Margin="0,0,0,12">
                                    <TextBlock Text="Command"
                                               Foreground="#A6ADC8"
                                               FontSize="12"
                                               Margin="0,0,0,6" />
                                    <TextBox Text="{Binding EditingServer.Command, UpdateSourceTrigger=PropertyChanged}"
                                             Background="#252536"
                                             Foreground="#CDD6F4"
                                             BorderBrush="#45475A"
                                             Padding="12,10" />
                                </StackPanel>
                                
                                <StackPanel Margin="0,0,0,12">
                                    <TextBlock Text="Arguments (one per line)"
                                               Foreground="#A6ADC8"
                                               FontSize="12"
                                               Margin="0,0,0,6" />
                                    <TextBox Text="{Binding EditingServer.Args, Converter={StaticResource ArrayToStringConverter}}"
                                             TextChanged="ArgsTextBox_TextChanged"
                                             Background="#252536"
                                             Foreground="#CDD6F4"
                                             BorderBrush="#45475A"
                                             Padding="12,10"
                                             AcceptsReturn="True"
                                             MinHeight="60" />
                                </StackPanel>
                                
                                <StackPanel Margin="0,0,0,12">
                                    <TextBlock Text="Working Directory"
                                               Foreground="#A6ADC8"
                                               FontSize="12"
                                               Margin="0,0,0,6" />
                                    <TextBox Text="{Binding EditingServer.WorkingDirectory, UpdateSourceTrigger=PropertyChanged}"
                                             Background="#252536"
                                             Foreground="#CDD6F4"
                                             BorderBrush="#45475A"
                                             Padding="12,10" />
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- HTTP configuration -->
                            <StackPanel Margin="0,0,0,16">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding EditingServer.Type}" Value="http">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <StackPanel Margin="0,0,0,12">
                                    <TextBlock Text="URL"
                                               Foreground="#A6ADC8"
                                               FontSize="12"
                                               Margin="0,0,0,6" />
                                    <TextBox Text="{Binding EditingServer.Url, UpdateSourceTrigger=PropertyChanged}"
                                             Background="#252536"
                                             Foreground="#CDD6F4"
                                             BorderBrush="#45475A"
                                             Padding="12,10" />
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Allowed Tools -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Allowed Tools (comma-separated, leave empty for all)"
                                           Foreground="#A6ADC8"
                                           FontSize="12"
                                           Margin="0,0,0,6" />
                                <TextBox Text="{Binding EditingServer.AllowedTools, Converter={StaticResource ArrayToStringConverter}}"
                                         TextChanged="AllowedToolsTextBox_TextChanged"
                                         Background="#252536"
                                         Foreground="#CDD6F4"
                                         BorderBrush="#45475A"
                                         Padding="12,10"
                                         MinHeight="40" />
                            </StackPanel>
                            
                            <!-- Tools list for connected server -->
                            <StackPanel Margin="0,0,0,16"
                                        Visibility="{Binding SelectedServer.ToolCount, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="{Binding SelectedServer.ToolCount, StringFormat='Available Tools ({0})'}"
                                           FontSize="14"
                                           FontWeight="SemiBold"
                                           Foreground="#CDD6F4"
                                           Margin="0,0,0,8" />
                                <Border Background="#181825"
                                        CornerRadius="6"
                                        Padding="12"
                                        MaxHeight="200">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding SelectedServer.Tools}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type models:McpToolViewModel}">
                                                    <Border Background="#252536"
                                                            CornerRadius="4"
                                                            Padding="10,8"
                                                            Margin="0,0,0,6">
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding Name}"
                                                                       Foreground="#89B4FA"
                                                                       FontWeight="SemiBold"
                                                                       FontSize="12" />
                                                            <TextBlock Text="{Binding Description}"
                                                                       Foreground="#A6ADC8"
                                                                       FontSize="11"
                                                                       TextWrapping="Wrap"
                                                                       Margin="0,4,0,0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>
                            
                            <!-- Action buttons -->
                            <StackPanel Orientation="Horizontal"
                                        HorizontalAlignment="Right"
                                        Margin="0,16,0,0">
                                <Button Command="{Binding TestConnectionCommand}"
                                        Content="Test Connection"
                                        Padding="16,10"
                                        Margin="0,0,12,0"
                                        Background="#F9E2AF"
                                        Foreground="#1E1E2E"
                                        FontWeight="SemiBold"
                                        Cursor="Hand"
                                        IsEnabled="{Binding SelectedServer, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Border" 
                                                    Background="{TemplateBinding Background}" 
                                                    CornerRadius="6" 
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Border" Property="Background" Value="#FAD5A5" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                                
                                <Button Command="{Binding EditServerCommand}"
                                        Content="Edit"
                                        Padding="16,10"
                                        Margin="0,0,12,0"
                                        Background="#45475A"
                                        Foreground="#CDD6F4"
                                        Cursor="Hand"
                                        Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolConverter}}">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Border" 
                                                    Background="{TemplateBinding Background}" 
                                                    CornerRadius="6" 
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Border" Property="Background" Value="#585B70" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                                
                                <Button Command="{Binding SaveServerCommand}"
                                        Content="Save"
                                        Padding="16,10"
                                        Margin="0,0,12,0"
                                        Background="#89B4FA"
                                        Foreground="#1E1E2E"
                                        FontWeight="SemiBold"
                                        Cursor="Hand">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Border" 
                                                    Background="{TemplateBinding Background}" 
                                                    CornerRadius="6" 
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Border" Property="Background" Value="#B4BEFE" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                                
                                <Button Command="{Binding CancelEditCommand}"
                                        Content="Cancel"
                                        Padding="16,10"
                                        Background="#45475A"
                                        Foreground="#CDD6F4"
                                        Cursor="Hand"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Border" 
                                                    Background="{TemplateBinding Background}" 
                                                    CornerRadius="6" 
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Border" Property="Background" Value="#585B70" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                        
                        <!-- Empty state -->
                        <TextBlock Text="Select a server to view details or add a new server"
                                   Foreground="#6C7086"
                                   FontSize="14"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Margin="0,40,0,0"
                                   Visibility="{Binding SelectedServer, Converter={StaticResource InverseBoolConverter}}" />
                    </StackPanel>
                </ScrollViewer>
            </Grid>
            
            <!-- Footer -->
            <StackPanel Grid.Row="2" 
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,20,0,0">
                <Button Content="Close"
                        Click="CloseButton_Click"
                        Padding="20,10"
                        Background="#45475A"
                        Foreground="#CDD6F4"
                        Cursor="Hand">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="Border" 
                                    Background="{TemplateBinding Background}" 
                                    CornerRadius="8" 
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Border" Property="Background" Value="#585B70" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>

