<UserControl x:Class="LlmTornado.WpfViews.Views.MessageBubble"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mdxaml="clr-namespace:MdXaml;assembly=MdXaml"
             xmlns:vm="clr-namespace:LlmTornado.WpfViews.ViewModels"
             xmlns:converters="clr-namespace:LlmTornado.WpfViews.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="200" d:DesignWidth="600"
             d:DataContext="{d:DesignInstance Type=vm:MessageViewModel}">
    
    <UserControl.Resources>
        <converters:RoleToColorConverter x:Key="RoleToColorConverter" />
        <converters:RoleToAlignmentConverter x:Key="RoleToAlignmentConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        
        <!-- Markdown styles -->
        <Style x:Key="MarkdownStyle" TargetType="FlowDocument">
            <Setter Property="FontFamily" Value="Segoe UI Variable, Segoe UI" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Foreground" Value="#CDD6F4" />
            <Setter Property="PagePadding" Value="0" />
        </Style>
    </UserControl.Resources>
    
    <Grid Margin="16,8" HorizontalAlignment="{Binding Role, Converter={StaticResource RoleToAlignmentConverter}}">
        <Border Background="{Binding Role, Converter={StaticResource RoleToColorConverter}}"
                CornerRadius="12"
                Padding="16,12"
                MaxWidth="700"
                MinWidth="100">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <!-- Role label -->
                <TextBlock Grid.Row="0"
                           Text="{Binding RoleDisplayName}"
                           FontWeight="SemiBold"
                           FontSize="12"
                           Foreground="#89B4FA"
                           Margin="0,0,0,8" />
                
                <!-- Message content with markdown -->
                <mdxaml:MarkdownScrollViewer Grid.Row="1"
                                              Markdown="{Binding Content}"
                                              VerticalScrollBarVisibility="Disabled"
                                              HorizontalScrollBarVisibility="Disabled"
                                              Background="Transparent">
                    <mdxaml:MarkdownScrollViewer.MarkdownStyle>
                        <Style TargetType="FlowDocument">
                            <Setter Property="FontFamily" Value="Segoe UI Variable, Segoe UI" />
                            <Setter Property="FontSize" Value="14" />
                            <Setter Property="Foreground" Value="#CDD6F4" />
                            <Setter Property="PagePadding" Value="0" />
                        </Style>
                    </mdxaml:MarkdownScrollViewer.MarkdownStyle>
                </mdxaml:MarkdownScrollViewer>
                
                <!-- Streaming indicator -->
                <StackPanel Grid.Row="2" 
                            Orientation="Horizontal" 
                            Margin="0,8,0,0"
                            Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Ellipse Width="6" Height="6" Fill="#89B4FA" Margin="0,0,4,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsStreaming}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     From="1" To="0.3" Duration="0:0:0.5"
                                                                     AutoReverse="True" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="Streaming..." 
                               FontSize="11" 
                               Foreground="#6C7086" />
                </StackPanel>
                
                <!-- Token count and timestamp -->
                <StackPanel Grid.Row="2" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Right"
                            Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}">
                    <TextBlock Text="{Binding TokenCount, StringFormat='{}{0} tokens'}"
                               FontSize="11"
                               Foreground="#6C7086"
                               Margin="0,8,8,0"
                               Visibility="{Binding TokenCount, Converter={StaticResource BoolToVisibilityConverter}}" />
                    <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}"
                               FontSize="11"
                               Foreground="#6C7086"
                               Margin="0,8,0,0" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>

